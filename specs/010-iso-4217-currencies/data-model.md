# Phase 1: Data Model Design

**Feature**: ISO 4217 Multi-Currency Support
**Date**: 2025-01-30
**Status**: Complete

## Overview

This document defines the data structures for the currency system, including the source JSON schema, generated Dart enum structure, and integration with existing models.

---

## Source Data Schema

### currencies.json

**Location**: `assets/currencies.json`

**Schema**:
```json
{
  "version": "1.0.0",
  "generatedAt": "2025-01-30T00:00:00Z",
  "source": "ISO 4217 + Unicode CLDR",
  "currencies": [
    {
      "code": "USD",
      "numericCode": "840",
      "name": "United States Dollar",
      "symbol": "$",
      "decimalPlaces": 2,
      "active": true
    },
    {
      "code": "EUR",
      "numericCode": "978",
      "name": "Euro",
      "symbol": "€",
      "decimalPlaces": 2,
      "active": true
    },
    {
      "code": "JPY",
      "numericCode": "392",
      "name": "Japanese Yen",
      "symbol": "¥",
      "decimalPlaces": 0,
      "active": true
    },
    {
      "code": "KWD",
      "numericCode": "414",
      "name": "Kuwaiti Dinar",
      "symbol": "KWD",
      "decimalPlaces": 3,
      "active": true
    }
    // ... 170+ total currencies
  ]
}
```

**Field Definitions**:

| Field | Type | Required | Description | Validation |
|-------|------|----------|-------------|------------|
| `code` | string | Yes | ISO 4217 3-letter alphabetic code | Uppercase A-Z, exactly 3 chars |
| `numericCode` | string | Yes | ISO 4217 3-digit numeric code | Digits only, exactly 3 chars |
| `name` | string | Yes | English display name | Non-empty string |
| `symbol` | string | Yes | Display symbol or fallback to code | Non-empty string |
| `decimalPlaces` | int | Yes | Number of minor units | 0, 2, or 3 |
| `active` | boolean | Yes | Whether currency is actively used | true/false |

**Maintenance Notes**:
- Update when ISO 4217 amendments published
- Inactive currencies marked `active: false` but retained for historical data
- Symbol sources: Unicode CLDR > Wikipedia > currency code fallback

---

## Generated Dart Code Structure

### currency_code.g.dart

**Generation Method**: Custom `build_runner` generator

**Output Structure**:

```dart
//
// GENERATED CODE - DO NOT MODIFY BY HAND
// Generated by: CurrencyCodeGenerator
// Source: assets/currencies.json
// Generated at: 2025-01-30T12:00:00.000Z
//

part of 'currency_code.dart';

/// ISO 4217 currency codes with metadata
///
/// This enum is generated from assets/currencies.json
/// To update: modify JSON file and run `dart run build_runner build`
enum CurrencyCode {
  /// United States Dollar ($, 2 decimals)
  usd('USD', 2),

  /// Euro (€, 2 decimals)
  eur('EUR', 2),

  /// Japanese Yen (¥, 0 decimals)
  jpy('JPY', 0),

  /// British Pound Sterling (£, 2 decimals)
  gbp('GBP', 2),

  /// Kuwaiti Dinar (KWD, 3 decimals)
  kwd('KWD', 3),

  // ... ~170 total enum values
  ;

  /// ISO 4217 alphabetic code (e.g., "USD", "EUR")
  final String code;

  /// Number of decimal places (minor units): 0, 2, or 3
  final int decimalPlaces;

  const CurrencyCode(this.code, this.decimalPlaces);
}

/// Extension methods for CurrencyCode
extension CurrencyCodeExtension on CurrencyCode {
  /// Currency symbol or code fallback
  String get symbol {
    switch (this) {
      case CurrencyCode.usd: return '\$';
      case CurrencyCode.eur: return '€';
      case CurrencyCode.gbp: return '£';
      case CurrencyCode.jpy: return '¥';
      case CurrencyCode.kwd: return 'KWD';
      // ... generated for all currencies
    }
  }

  /// English display name
  String get displayName {
    switch (this) {
      case CurrencyCode.usd: return 'United States Dollar';
      case CurrencyCode.eur: return 'Euro';
      case CurrencyCode.gbp: return 'British Pound Sterling';
      case CurrencyCode.jpy: return 'Japanese Yen';
      case CurrencyCode.kwd: return 'Kuwaiti Dinar';
      // ... generated for all currencies
    }
  }

  /// Localized display name (uses app localization if available)
  String displayNameLocalized(BuildContext context) {
    // For now, return English name
    // Future: integrate with l10n when multi-language support added
    return displayName;
  }

  /// Whether currency is actively used
  bool get isActive {
    switch (this) {
      case CurrencyCode.usd:
      case CurrencyCode.eur:
      case CurrencyCode.gbp:
      case CurrencyCode.jpy:
      case CurrencyCode.kwd:
        return true;
      // ... most are true, historical currencies are false
      default:
        return true;
    }
  }

  /// Parse currency code string to enum
  ///
  /// Returns null if code is invalid or inactive
  /// Case-insensitive matching
  static CurrencyCode? fromString(String? code) {
    if (code == null || code.isEmpty) return null;

    final normalized = code.trim().toUpperCase();

    switch (normalized) {
      case 'USD': return CurrencyCode.usd;
      case 'EUR': return CurrencyCode.eur;
      case 'GBP': return CurrencyCode.gbp;
      case 'JPY': return CurrencyCode.jpy;
      case 'KWD': return CurrencyCode.kwd;
      // ... generated for all currencies
      default: return null;
    }
  }

  /// Get all active currencies (for currency picker)
  static List<CurrencyCode> get activeCurrencies {
    return CurrencyCode.values.where((c) => c.isActive).toList();
  }
}
```

**Generated Code Size Estimate**:
- ~170 enum values × 5 lines each = ~850 lines
- Symbol switch: ~170 cases × 1 line = ~170 lines
- Display name switch: ~170 cases × 1 line = ~170 lines
- fromString switch: ~170 cases × 1 line = ~170 lines
- **Total: ~1,400 lines** (well within acceptable range)

---

## Wrapper File Structure

### currency_code.dart (Wrapper)

**Location**: `lib/core/models/currency_code.dart`

**Purpose**: Thin wrapper that imports generated code and provides public API

**Structure**:
```dart
import 'package:flutter/material.dart';

part 'currency_code.g.dart';

// Enum and extension defined in generated file

// No additional code needed - generated file is self-contained
// This file exists only to establish the part relationship
```

**Migration Note**: Existing file will be simplified to remove hardcoded enums

---

## Integration with Existing Models

### Trip Model

**File**: `lib/features/trips/domain/models/trip.dart`

**Current**:
```dart
class Trip {
  final CurrencyCode baseCurrency;  // Already uses enum
  // ...
}
```

**Changes**: None required (enum API unchanged)

**Serialization** (`lib/features/trips/data/models/trip_model.dart`):
```dart
// To JSON
'baseCurrency': trip.baseCurrency.code,  // Still string

// From JSON
baseCurrency: CurrencyCode.fromString(data['baseCurrency']) ?? CurrencyCode.usd,
```

**Backward Compatibility**: Existing "USD" and "VND" strings parse correctly

---

### Expense Model

**File**: `lib/features/expenses/domain/models/expense.dart`

**Current**:
```dart
class Expense {
  final CurrencyCode currency;  // Already uses enum
  final Decimal amount;
  // ...
}
```

**Changes**: None required

**Serialization** (`lib/features/expenses/data/models/expense_model.dart`):
```dart
// To JSON
'currency': expense.currency.code,  // Still string

// From JSON
currency: CurrencyCode.fromString(data['currency']) ?? CurrencyCode.usd,
```

---

## Validation Rules

### JSON Schema Validation

**Validation During Generation**:
1. All required fields present (code, numericCode, name, symbol, decimalPlaces, active)
2. `code` is 3 uppercase letters (regex: `^[A-Z]{3}$`)
3. `numericCode` is 3 digits (regex: `^\d{3}$`)
4. `decimalPlaces` is 0, 2, or 3 (no other values allowed)
5. `name` is non-empty string
6. `symbol` is non-empty string
7. `active` is boolean
8. No duplicate `code` values
9. Enum name (lowercase code) is valid Dart identifier

**Error Handling**:
- Generator fails build if validation fails
- Error messages indicate specific validation failure and line number

---

## State Transitions

### Currency Lifecycle

```
[New Currency Added]
       ↓
[Added to currencies.json with active: true]
       ↓
[Build runner generates enum value]
       ↓
[Available in CurrencySearchField picker]
       ↓
[Users can select for trips/expenses]
       ↓
[Currency deprecated by ISO 4217]
       ↓
[Set active: false in currencies.json]
       ↓
[Still in enum (backward compatibility)]
       ↓
[Hidden from picker (isActive = false)]
       ↓
[Existing data still valid]
```

**Key Principle**: Never remove currencies from JSON (preserve backward compatibility)

---

## Performance Considerations

### Enum Size Impact

**Concerns**:
- Large enum with 170 values
- Large switch statements for symbol/displayName

**Mitigations**:
- Dart enums are compiled to integers (minimal memory)
- Switch statements compile to jump tables (O(1) lookup)
- Generated code is tree-shakeable (unused currencies removed in release builds)

**Benchmarks** (estimated):
- Enum construction: <1ms
- fromString() lookup: <1ms (170-case switch is fast)
- symbol/displayName lookup: <1ms

### Build Time Impact

**Estimate**:
- Read JSON: ~10ms
- Parse JSON: ~50ms
- Generate 1,400 lines of code: ~100ms
- Write file: ~20ms
- **Total: ~200ms** (acceptable for build_runner)

---

## Testing Strategy

### Unit Tests

**Test File**: `test/core/models/currency_code_test.dart`

**Test Cases**:
1. All enum values exist (USD, EUR, GBP, JPY, KWD, etc.)
2. Decimal places correct (USD=2, JPY=0, KWD=3)
3. Symbols correct (USD=$, EUR=€, GBP=£, JPY=¥)
4. Display names correct (USD=United States Dollar, etc.)
5. `fromString()` parses valid codes (USD, usd, Usd all work)
6. `fromString()` returns null for invalid codes
7. `activeCurrencies` excludes inactive currencies
8. Backward compatibility: "USD" and "VND" strings parse correctly

### Generator Tests

**Test File**: `test/generators/currency_code_generator_test.dart`

**Test Cases**:
1. Generator produces valid Dart code
2. Generator handles missing fields (fails build)
3. Generator handles invalid decimal places (fails build)
4. Generator handles duplicate codes (fails build)
5. Generated code compiles without errors

---

## Migration Checklist

- [ ] Create `assets/currencies.json` with 170+ currencies
- [ ] Create `lib/generators/currency_code_generator.dart`
- [ ] Configure `build.yaml` for currency code generation
- [ ] Run `dart run build_runner build` to generate `currency_code.g.dart`
- [ ] Update `currency_code.dart` to import generated file
- [ ] Run tests to verify backward compatibility (USD/VND still work)
- [ ] Update tests to use wider range of currencies (not just USD/VND)
- [ ] Commit both JSON and generated `.g.dart` file

---

## Future Enhancements

### Multi-Language Display Names

**Current**: English only in `displayName` getter

**Future**: Integrate with Flutter l10n system

```dart
String displayNameLocalized(BuildContext context) {
  switch (this) {
    case CurrencyCode.usd: return context.l10n.currencyUSD;
    case CurrencyCode.eur: return context.l10n.currencyEUR;
    // ...
  }
}
```

**Requirement**: Add 170 entries × N languages to ARB files

### Exchange Rate Support

**Current**: Out of scope for this feature

**Future**: Add FX rate data to Trip model, implement conversion in settlement calculations

**Related Entity**:
```dart
class ExchangeRate {
  final CurrencyCode fromCurrency;
  final CurrencyCode toCurrency;
  final Decimal rate;
  final DateTime effectiveDate;
}
```

---

**Status**: Data model design complete. Ready for contract definition.
